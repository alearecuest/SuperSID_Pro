<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperSID Pro - VLF Real-time Dashboard</title>

    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/static/css/dashboard.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .observatory-section {
            padding: 0 20px;
        }

        .observatory-card {
            background: var(--bg-card);
        }

        .observatory-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-value {
            font-weight: 600;
            color: var(--info);
        }

        .loading-message {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>
                    <img src="/static/images/radioastronomylogo.png" alt="SuperSID Pro" 
                         style="height: 40px; margin-right: 10px; vertical-align: middle;">
                    SuperSID Pro
                </h1>
                <span class="subtitle">VLF Real-time Monitoring Dashboard</span>
            </div>
            
            <div class="header-right">
                <div class="status-indicator" id="connectionStatus">
                    <i class="fas fa-circle"></i>
                    <span>Connecting...</span>
                </div>
                
                <div class="controls">
                    <button id="startBtn" class="btn btn-success" disabled>
                        <i class="fas fa-play"></i> Start
                    </button>
                    <button id="stopBtn" class="btn btn-danger" disabled>
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button id="clearBtn" class="btn btn-secondary">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                
                <div class="timestamp" id="timestamp">
                    Loading...
                </div>
            </div>
        </header>

        <section class="observatory-section" style="margin-bottom: 20px;">
            <div class="card observatory-card">
                <div class="card-header">
                    <i class="fas fa-building"></i>
                    <h3>Observatory Information</h3>
                </div>
                <div class="card-content">
                    <div class="observatory-info">
                        <div class="info-item">
                            <span>Observatory: </span>
                            <span id="obsName" class="info-value">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span>Monitor ID:</span>
                            <span id="obsMonitorId" class="info-value">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span>Location:</span>
                            <span id="obsLocation" class="info-value">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span>Coordinates:</span>
                            <span id="obsCoordinates" class="info-value">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <main class="main-content">
            <section class="status-cards">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-signal"></i>
                        <h3>System Status</h3>
                    </div>
                    <div class="card-content">
                        <div class="status-item">
                            <span>Monitoring:</span>
                            <span id="monitoringStatus" class="status-value">Stopped</span>
                        </div>
                        <div class="status-item">
                            <span>Data Rate:</span>
                            <span id="dataRate" class="status-value">0 Hz</span>
                        </div>
                        <div class="status-item">
                            <span>Total Points:</span>
                            <span id="totalPoints" class="status-value">0</span>
                        </div>
                        <div class="status-item">
                            <span>WebSocket:</span>
                            <span id="wsStatus" class="status-value">Disconnected</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Anomalies</h3>
                    </div>
                    <div class="card-content">
                        <div id="anomalyList" class="anomaly-list">
                            <div class="no-anomalies">No anomalies detected</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-database"></i>
                        <h3>Current Values</h3>
                    </div>
                    <div class="card-content">
                        <div class="current-values" id="currentValues">
                            <div class="loading-message">Loading observatory configuration...</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-sun"></i>
                        <h3>Space Weather</h3>
                    </div>
                    <div class="card-content">
                        <div id="spaceWeatherStatus" class="space-weather-status">
                            <div class="status-item">
                                <span>Status:</span>
                                <span id="solarActivity" class="status-value">Loading...</span>
                            </div>
                            <div class="status-item">
                                <span>Kp Index:</span>
                                <span id="kpIndex" class="status-value">--</span>
                            </div>
                            <div class="status-item">
                                <span>Solar Wind: </span>
                                <span id="solarWindSpeed" class="status-value">-- km/s</span>
                            </div>
                            <div class="status-item">
                                <span>Last Update:</span>
                                <span id="spaceWeatherUpdate" class="status-value">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="charts-section">
                <div class="charts-grid" id="chartsGrid">
                    <div class="loading-message">Loading station charts...</div>
                </div>

                <div class="chart-container overview">
                    <div class="chart-header">
                        <h4>All Stations Overview</h4>
                        <div class="chart-controls">
                            <select id="timeRange" class="time-selector">
                                <option value="1">Last 1 minute</option>
                                <option value="5" selected>Last 5 minutes</option>
                                <option value="15">Last 15 minutes</option>
                                <option value="60">Last 1 hour</option>
                            </select>
                        </div>
                    </div>
                    <canvas id="overviewChart"></canvas>
                </div>
            </section>
        </main>

        <footer class="footer">
            <div class="footer-left">
                <span>SuperSID Pro v1.0.0</span>
                <span>|</span>
                <span id="observatoryFooter">Solar Observatory Monitoring System</span>
            </div>
            <div class="footer-right">
                <span id="serverTime"></span>
            </div>
        </footer>
    </div>

    <script>
        let ws = null;
        let isMonitoring = false;
        let observatoryConfig = null;
        let totalDataPoints = 0;
        let charts = {};
        let chartColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD'];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loading...');
            initializeDashboard();
        });

        async function initializeDashboard() {
            try {
                await loadObservatoryConfig();
                initializeWebSocket();
                initializeCharts();
                setupTimeRangeSelector();
                setupEventListeners();
                updateSpaceWeather();
                setInterval(updateTimestamp, 1000);
                
                console.log('Dashboard initialized successfully');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            }
        }

        function createDynamicCharts() {
            if (! observatoryConfig) return;
            
            const stations = observatoryConfig.vlf_stations?.monitored_stations || [];
            const stationFreqs = observatoryConfig.vlf_stations?.station_frequencies || {};
            const chartsGrid = document.getElementById('chartsGrid');
            
            chartsGrid.innerHTML = '';
            
            stations.forEach((station, index) => {
                const freq = stationFreqs[station]?.freq || 0;
                const location = stationFreqs[station]?.location || '';
                
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = `
                    <div class="chart-header">
                        <h4>${station} (${freq} kHz)</h4>
                        <div class="chart-status" id="station${index + 1}Status">
                            <span class="frequency">0. 00 kHz</span>
                            <span class="amplitude">0.000 V</span>
                        </div>
                    </div>
                    <canvas id="station${index + 1}Chart"></canvas>
                `;
                
                chartsGrid.appendChild(chartContainer);
                
                const canvas = chartContainer.querySelector('canvas');
                const chartId = `station${index + 1}Chart`;
                const colorIndex = index % chartColors.length;
                
                charts[chartId] = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Amplitude',
                            data: [],
                            borderColor:  chartColors[colorIndex],
                            backgroundColor: chartColors[colorIndex] + '20',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction:  {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            x: {
                                display: true,
                                grid:  { color: '#444444' },
                                ticks: { color:  '#cccccc', maxTicksLimit: 6 }
                            },
                            y: {
                                display: true,
                                grid:  { color: '#444444' },
                                ticks: { color: '#cccccc' },
                                beginAtZero:  true
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        },
                        animation: { duration: 0 }
                    }
                });
            });
            
            console.log(`Created ${stations.length} dynamic charts for stations:  ${stations.join(', ')}`);
        }

        function initializeCharts() {
            createDynamicCharts();
            
            const overviewCtx = document.getElementById('overviewChart');
            if (overviewCtx && ! charts.overviewChart) {
                charts.overviewChart = new Chart(overviewCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        scales: {
                            x: {
                                display: true,
                                grid: { color: '#444444' },
                                ticks: { color: '#cccccc', maxTicksLimit: 10 }
                            },
                            y: {
                                display: true,
                                grid:  { color: '#444444' },
                                ticks: { color: '#cccccc' },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#cccccc', usePointStyle: true }
                            }
                        },
                        animation: { duration: 0 }
                    }
                });
            }
            
            console.log('Charts initialized successfully');
        }

        function updateChart(chartId, timestamp, amplitude) {
            const chart = charts[chartId];
            if (!chart) return;
            
            const timeString = new Date(timestamp).toLocaleTimeString();
            
            chart.data.labels.push(timeString);
            chart.data.datasets[0].data.push(amplitude);
            
            const timeRange = parseInt(document.getElementById('timeRange').value);
            const maxPoints = timeRange * 60;
            
            if (chart. data.labels.length > maxPoints) {
                chart.data. labels.shift();
                chart. data.datasets[0].data. shift();
            }
            
            chart.update('none');
        }

        function updateOverviewChart(timestamp, stationsData) {
            const overview = charts.overviewChart;
            if (!overview || !observatoryConfig) return;
            
            const stations = observatoryConfig.vlf_stations?.monitored_stations || [];
            const stationFreqs = observatoryConfig.vlf_stations?.station_frequencies || {};
            const timeString = new Date(timestamp).toLocaleTimeString();
            
            if (overview.data.datasets.length === 0) {
                stations.forEach((station, index) => {
                    const freq = stationFreqs[station]?.freq || 0;
                    const colorIndex = index % chartColors.length;
                    overview.data.datasets.push({
                        label: `${station} (${freq} kHz)`,
                        data: [],
                        borderColor: chartColors[colorIndex],
                        backgroundColor: chartColors[colorIndex] + '20',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    });
                });
            }
            
            overview.data.labels. push(timeString);
            
            overview.data.datasets.forEach((dataset, index) => {
                const stationKey = `BAND_${index + 1}`;
                const amplitude = stationsData[stationKey]?.amplitude || 0;
                dataset.data.push(amplitude);
            });
            
            const timeRange = parseInt(document.getElementById('timeRange').value);
            const maxPoints = timeRange * 60;
            
            if (overview.data.labels. length > maxPoints) {
                overview.data.labels.shift();
                overview.data.datasets. forEach(dataset => {
                    dataset.data.shift();
                });
            }
            
            overview.update('none');
        }

        function setupTimeRangeSelector() {
            const selector = document.getElementById('timeRange');
            if (selector) {
                selector.addEventListener('change', function() {
                    const minutes = parseInt(this.value);
                    const maxPoints = minutes * 60;
                    
                    Object. values(charts).forEach(chart => {
                        while (chart.data.labels.length > maxPoints) {
                            chart.data.labels.shift();
                            chart.data.datasets. forEach(dataset => {
                                dataset.data.shift();
                            });
                        }
                        chart.update();
                    });
                    
                    console.log(`Time range updated to ${minutes} minutes`);
                });
            }
        }

        function clearCharts() {
            Object. values(charts).forEach(chart => {
                chart.data.labels = [];
                chart.data.datasets.forEach(dataset => {
                    dataset.data = [];
                });
                chart.update();
            });
            
            document.querySelectorAll('.band-value').forEach(el => el.textContent = '0.000');
            
            document.getElementById('anomalyList').innerHTML = '<div class="no-anomalies">No anomalies detected</div>';
            
            totalDataPoints = 0;
            updateDataStats();
            
            console.log('Charts and data cleared');
        }

        async function loadObservatoryConfig() {
            try {
                console.log('Loading observatory config...');
                const response = await fetch('/api/config');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                observatoryConfig = result;
                console.log('Observatory config loaded:', observatoryConfig);
                
                updateObservatoryInfo();
                updateCurrentValuesSection();
                
            } catch (error) {
                console.error('Error loading observatory config:', error);
                observatoryConfig = {
                    observatory: { 
                        name: 'Observatory', 
                        monitor_id: '--', 
                        location: 'Loading...',
                        coordinates: { latitude: 0, longitude: 0 }
                    },
                    vlf_stations:  { 
                        monitored_stations: ['NPM', 'GQD', 'DHO38', 'NAA'],
                        station_frequencies: {
                            'NPM': { freq: 21.4 },
                            'GQD': { freq: 22.1 },
                            'DHO38': { freq: 23.4 },
                            'NAA': { freq: 24.0 }
                        }
                    }
                };
                updateObservatoryInfo();
                updateCurrentValuesSection();
            }
        }

        function updateObservatoryInfo() {
            if (!observatoryConfig) return;
            
            const obs = observatoryConfig.observatory || {};
            
            document.getElementById('obsName').textContent = obs.name || 'Unknown';
            document.getElementById('obsMonitorId').textContent = obs.monitor_id || 'Unknown';
            document.getElementById('obsLocation').textContent = obs.location || 'Unknown';
            
            const coords = obs.coordinates || {};
            document.getElementById('obsCoordinates').textContent = 
                `${coords.latitude || 0}°, ${coords.longitude || 0}°`;
            
            const footerElement = document.getElementById('observatoryFooter');
            if (footerElement) {
                footerElement.textContent = `${obs.name || 'Observatory'} Monitoring System`;
            }
        }

        function updateCurrentValuesSection() {
            if (!observatoryConfig) return;
            
            const stations = observatoryConfig.vlf_stations?.monitored_stations || [];
            const stationFreqs = observatoryConfig.vlf_stations?.station_frequencies || {};
            
            const currentValuesDiv = document.getElementById('currentValues');
            currentValuesDiv.innerHTML = '';
            
            stations.forEach((station, index) => {
                const freq = stationFreqs[station]?.freq || 0;
                const div = document.createElement('div');
                div.className = 'value-row';
                div.innerHTML = `
                    <span class="band-name">${station}:</span>
                    <span class="band-value" id="station${index + 1}Value">0.000</span>
                `;
                currentValuesDiv.appendChild(div);
            });
        }

        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            console.log('Connecting to WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                console.log('WebSocket connected');
                updateConnectionStatus('Connected', 'connected');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('wsStatus').textContent = 'Connected';
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                updateConnectionStatus('Disconnected', 'disconnected');
                document.getElementById('wsStatus').textContent = 'Disconnected';
                document.getElementById('startBtn').disabled = true;
                setTimeout(initializeWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console. error('WebSocket error:', error);
                updateConnectionStatus('Error', 'error');
            };
        }

        function handleWebSocketMessage(data) {
            console.log('WebSocket message received:', data. type);
            switch(data.type) {
                case 'vlf_data':  
                    updateVLFData(data);
                    break;
                case 'anomaly':   
                    addAnomaly(data);
                    break;
                case 'connection':   
                    console.log('WebSocket connection message:', data.message);
                    break;
            }
        }

        function updateVLFData(data) {
            if (!observatoryConfig) return;
            
            const stations = observatoryConfig.vlf_stations?.monitored_stations || [];
            const timestamp = new Date(data.timestamp);
            totalDataPoints++;
            
            stations.forEach((station, index) => {
                const stationKey = `BAND_${index + 1}`;
                const signalData = data.signals[stationKey];
                
                if (signalData) {
                    const valueElement = document.getElementById(`station${index + 1}Value`);
                    if (valueElement) {
                        valueElement. textContent = signalData.amplitude. toFixed(3);
                    }
                    
                    const statusElement = document.getElementById(`station${index + 1}Status`);
                    if (statusElement) {
                        const freqSpan = statusElement.querySelector('.frequency');
                        const ampSpan = statusElement.querySelector('.amplitude');
                        if (freqSpan) freqSpan.textContent = `${signalData.frequency.toFixed(2)} kHz`;
                        if (ampSpan) ampSpan.textContent = `${signalData.amplitude.toFixed(3)} V`;
                    }
                    
                    const chartId = `station${index + 1}Chart`;
                    if (charts[chartId]) {
                        updateChart(chartId, timestamp, signalData.amplitude);
                    }
                }
            });
            
            updateOverviewChart(timestamp, data.signals);
            updateDataStats();
        }

        function setupEventListeners() {
            document.getElementById('startBtn').addEventListener('click', startMonitoring);
            document.getElementById('stopBtn').addEventListener('click', stopMonitoring);
            document.getElementById('clearBtn').addEventListener('click', clearCharts);
        }

        async function startMonitoring() {
            try {
                console.log('Starting monitoring...');
                const response = await fetch('/api/start', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'started') {
                    isMonitoring = true;
                    document.getElementById('startBtn').disabled = true;
                    document. getElementById('stopBtn').disabled = false;
                    document.getElementById('monitoringStatus').textContent = 'Active';
                    document.getElementById('monitoringStatus').className = 'status-value active';
                    console.log('Monitoring started successfully');
                }
            } catch (error) {
                console.error('Error starting monitoring:', error);
            }
        }

        async function stopMonitoring() {
            try {
                console.log('Stopping monitoring...');
                const response = await fetch('/api/stop', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'stopped') {
                    isMonitoring = false;
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('monitoringStatus').textContent = 'Stopped';
                    document.getElementById('monitoringStatus').className = 'status-value stopped';
                    console.log('Monitoring stopped successfully');
                }
            } catch (error) {
                console.error('Error stopping monitoring:', error);
            }
        }

        function updateConnectionStatus(status, className) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.className = `status-indicator ${className}`;
                const span = statusElement.querySelector('span');
                if (span) span.textContent = status;
            }
        }

        async function updateSpaceWeather() {
            try {
                console.log('Updating space weather.. .');
                const response = await fetch('/api/space-weather/summary');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                document.getElementById('solarActivity').textContent = data. status || 'Unknown';
                document.getElementById('kpIndex').textContent = data. kp_index || '--';
                document.getElementById('solarWindSpeed').textContent = data.solar_wind_speed || '-- km/s';
                
                if (data.last_update) {
                    const updateTime = new Date(data.last_update).toLocaleTimeString();
                    document.getElementById('spaceWeatherUpdate').textContent = updateTime;
                }
                
                console.log('Space weather updated:', data. status);
                
            } catch (error) {
                console.error('Error updating space weather:', error);
                document.getElementById('solarActivity').textContent = 'Loading...';
                document.getElementById('kpIndex').textContent = '--';
                document.getElementById('solarWindSpeed').textContent = '-- km/s';
            }
        }

        function updateDataStats() {
            document.getElementById('totalPoints').textContent = totalDataPoints;
            document.getElementById('dataRate').textContent = isMonitoring ? '1. 0 Hz' : '0 Hz';
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleTimeString();
            document.getElementById('serverTime').textContent = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
        }

        function addAnomaly(data) {
            const anomalyList = document.getElementById('anomalyList');
            
            const noAnomalies = anomalyList.querySelector('.no-anomalies');
            if (noAnomalies) {
                noAnomalies.remove();
            }
            
            data.anomalies.forEach(anomaly => {
                const div = document.createElement('div');
                div.className = 'anomaly-item';
                div. innerHTML = `
                    <span class="anomaly-time">${new Date(data.timestamp).toLocaleTimeString()}</span>
                    <span class="anomaly-message">${anomaly}</span>
                `;
                anomalyList.insertBefore(div, anomalyList.firstChild);
            });
            
            while (anomalyList.children.length > 5) {
                anomalyList.removeChild(anomalyList.lastChild);
            }
        }

        setInterval(updateSpaceWeather, 300000);
    </script>
</body>
</html>